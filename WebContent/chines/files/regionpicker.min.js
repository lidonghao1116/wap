(function($, cr) {

  'use strict';
  var RegionPicker = function(el, options){
    this.el = el;
    this.options = $.extend({
      remote: '',
      picked: '',
      visible: 10,
      animate: 0
    }, options || {});
    this.picker = null;

    this.options.picked = String(this.options.picked);
    this.options.visible = parseInt(this.options.visible, 10) || 10;
    this.options.animate = parseInt(this.options.animate, 10) || 0;    

    this.data = { regions: [], collections: [], id:''};

    this.el.on('initializing.rp', $.proxy(this._onInitializing, this));
    this.el.on('initialized.rp', $.proxy(this._onInitialized, this));
    $(document).on('keydown', $.proxy(this._onCloserClick, this));

    new cr.RegionPicker({
      remote: this.options.remote,
      initialized: $.proxy(this._preInitialize, this)
    });
  };

  RegionPicker.prototype = {
    constructor: RegionPicker,

    _preInitialize: function(picker){
      this.picker = picker;
      this.el.trigger('initializing.rp', [this]);
      this.picker.pick(this.options.picked, $.proxy(function(regions, collections){
        this.data.regions = regions;
        this.data.collections = collections;
        this.el.trigger('initialized.rp', [this]);
      }, this));
    },

    _onInitializing: function(){
      this.renderer = $('<div id="region-picker" style="display:none;"></div>')
      	.append('<div class="innter"><a href="javascript:;" class="closer" title="cancel"><img src="area/iconfont.png"></a></div>')
        .append('<div class="regions"></div>')
        .appendTo('body');
      this.renderer.after('<div class="fixed_vc"></div>');
      this.renderer.on('rendered', '.region-list', $.proxy(this._onListRendered, this));
      this.renderer.on('reveal', $.proxy(this._render, this));
      this.renderer.on('picked', '.region-list li', $.proxy(this._onItemPicked, this));
      this.renderer.on('click', '.region-list li', $.proxy(this._onItemClick, this));
      this.renderer.on('click', '.closer', $.proxy(this._onCloserClick, this));
    },

    _onInitialized: function(){
      this.el.on('click', $.proxy(this._onClick, this));
    },

    _onClick: function(e){
      e.preventDefault();
      if(this.renderer.css('display') !== 'none'){
        return;
      }
      var wh=$('body').outerWidth(true),ht=document.body.scrollHeight;
      this.renderer.find('.innter').find('span').remove();
      this.renderer.css({
    	  'left': (wh>640)?(wh-640)/2+'px':'0px',top: '0px',height: ht+'px'})
    	  .fadeIn(this.options.animate).trigger('reveal');
      this.renderer.next().addClass('in');
    },

    _onItemClick: function(e){
      var el = $(e.currentTarget), id = el.attr('data-id');
      e.preventDefault();
      if(this.data.id == id){
  		return;
  	  }
      this.el.trigger('loading.rp', this);
      this.picker.pick(id, $.proxy(function(regions, collections){
    	this.data.id = id;
        this.data.regions = regions;
        this.data.collections = collections;
        this.el.trigger('loaded.rp', [this.data, this]);

        var leafNode = (regions[regions.length - 1] && id === regions[regions.length - 1].i);
        if(leafNode || leafNode==undefined){
          this.el.trigger('picked.rp', [regions, this]);
          this._onCloserClick(e);
        }else{
          this.renderer.trigger('reveal');
        }
      }, this));
    },

    _onItemPicked: function(e, list, index, height){
      e.stopPropagation();

      var offset = index - this.options.visible + 1;
      if(offset>=0){
        list.animate({scrollTop: (offset + 1) * height}, Math.max(this.options.animate * 1.5, 200));
      }
    },

    _onCloserClick: function(e){
      if(e.type === 'click' || (e.type === 'keydown' && e.which === 27)){
        e.stopPropagation();
        if(this.renderer.css('display') !== 'none'){
          this.renderer.fadeOut(this.options.animate);
          this.renderer.next().removeClass('in');
          this.data.id = "";
        }
      }
    },

    _onListRendered: function(e, region){
      var list = $(e.currentTarget), h = $('li:first', list).outerHeight(true);
      $('li', list).each(function(i){
        if($(this).attr('data-id') === region.i){
          $(this).addClass('picked').trigger('picked', [list, i, h]);
        }
      });
    },
    _inArray: function(){
    	var id = this.data.id,u=-1;
    	if(id=='')return u;
    	this.data.regions.forEach(function(a,i){
    		if(id==a.i) u = i;
    	})
    	return u;
    },
    _render: function(){
      var container = $('.regions', this.renderer).empty();
      var i = this._inArray();
      if(i!=-1){
    	  var hm = "";
    	  for(var n=0;n<=i;n++){
    		  var obj = this.data.regions[n];
    		  hm+='<span data-id="'+obj.i+'">'+obj.n+'</span>';
    	  }
    	  this.renderer.find('.innter').append(hm);
    	  this.renderer.find('.innter').on('click', 'span', $.proxy(this._onItemClick, this));
      }
      $('<ul class="region-list"></ul>')
      .append(this._renderItems(this.data.collections[i+1]))
      .appendTo(container)
      .trigger('rendered', [this.data.regions[i+1]]);
    },
    _renderUl: function(i,m){
    	
    },
    _renderItems: function(collection){
      var items = [], r;
      for(var i = 0; i< collection.length; i++){
        r = collection[i];
        items.push($('<li data-id="'+r.i+'">'+r.n+'</li>').fadeIn(this.options.animate));
      }
      return items;
    }
  };

  $.fn.regionPicker = function(options){
    return this.each(function(){
      var self = $(this), data = self.data("regionpicker");
      if (!data){
        var opts = $.extend(self.data(), options || {} );
        self.data('regionpicker', (data = new RegionPicker(self, opts)));
      }
    });
  };

})(jQuery, ChineseRegion);